services:
  db:
    image: postgres:16-alpine
    container_name: go-nmos-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: go_nmos
    volumes:
      - go_nmos_db:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d go_nmos"]
      interval: 2s
      timeout: 5s
      retries: 10
      start_period: 5s

  mqtt:
    image: eclipse-mosquitto:2
    container_name: go-nmos-mqtt
    ports:
      - "${MQTT_HOST_PORT:-1883}:1883"
      - "${MQTT_WS_HOST_PORT:-9001}:9001"
    volumes:
      - ./deploy/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro

  backend:
    build:
      context: ./backend
    container_name: go-nmos-backend
    env_file:
      - ./backend/.env
    environment:
      # Override for Docker: connect to db service (ignore DATABASE_URL from .env if it points to host)
      DATABASE_URL: postgres://postgres:postgres@db:5432/go_nmos?sslmode=disable
      # Container listens on 8080; host 9090 is mapped to container 8080
      APP_PORT: "8080"
      # Broker is the mqtt service in same compose; localhost from .env would point to container itself
      MQTT_BROKER_URL: tcp://mqtt:1883
    depends_on:
      db:
        condition: service_healthy
      mqtt:
        condition: service_started
    volumes:
      - ./logs:/tmp/go-nmos-logs
      - ./certs:/certs:ro
    ports:
      - "9090:8080"
      - "${HTTPS_PORT:-8443}:${HTTPS_PORT:-8443}"

  frontend:
    build:
      context: ./frontend
    container_name: go-nmos-frontend
    depends_on:
      - backend
    ports:
      - "4173:80"

volumes:
  go_nmos_db:
